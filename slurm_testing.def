BootStrap: docker
From: rocker/r-ver:4.3.2

%files
%files
    renv.lock /project/renv.lock
    renv/ /project/renv/


%post
    # Set up locales
    apt-get update && apt-get install -y locales
    locale-gen en_US.UTF-8
    echo "LANG=en_US.UTF-8" >> /etc/default/locale
    echo "LC_ALL=en_US.UTF-8" >> /etc/default/locale
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8

    # Prevent renv auto-activation inside the container build
    export R_PROFILE=NULL
    export R_ENVIRON=NULL    

    # Basic utilities
    # Update system and install necessary dependencies
    apt-get update && apt-get install -y \
        software-properties-common \
        bash \
        coreutils \
        curl \
        gnupg \
        ca-certificates \
        cmake \
        libcurl4-openssl-dev \
        libxml2-dev \
        libssl-dev \
        libgdal-dev \
        libproj-dev \
        libgeos-dev \
        libnode-dev \
        libsodium-dev \
        libgit2-dev \
        libprotobuf-dev \
        protobuf-compiler \
        pkg-config \
        unzip \
        wget \
        git \
        libicu-dev \
        libblas-dev \
        liblapack-dev \
        gfortran \
        libreadline-dev \
        tzdata \
        libx11-dev \
        libxt-dev \
        libxmu-dev \
        libbz2-dev \
        libnng-dev \
        libfontconfig1-dev \
        libfreetype6-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        slurm-client \
        lmod \
        libboost-dev \
        libboost-system-dev \
        libboost-filesystem-dev \
        libboost-chrono-dev \
        build-essential \
        libglpk-dev \
        libglpk40 \
        libgmp-dev \
        && rm -rf /var/lib/apt/lists/*



    # Create project directory
    mkdir -p /project
    cd /project

    # Pre-install some bootstrap packages so renv can resolve dependencies faster
    Rscript --no-init-file -e "install.packages(c('renv','pak','devtools'), repos = 'https://cloud.r-project.org')"

    # Restore packages defined in renv.lock
    Rscript -e 'renv::restore(lockfile = "/project/renv.lock", prompt = FALSE)'

%environment
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    export TERM=xterm-256color
    export WORKDIR=/project
    export RENV_PATHS_CACHE=/renv/cache
    export R_LIBS_USER=/project/renv/library

%runscript
    cd /project
    exec "$@"

%labels
    Project-specific R 4.3.2 container with renv restored
